<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="pt">

	<select id="selectTraineeList" parameterType="int" resultType="com.javaex.vo.PtVo">
		<![CDATA[
		
			SELECT
			    pt.ptNo, u.userNo, u.userId, u.name, to_char(pt.endDate, 'yyyymmdd') endDate, pt.regcount, NVL(pt.schedulecount, 0) schdulecount
			FROM
			    users u,
			    (SELECT
			        p.ptNo, p.userNo, p.endDate,
			        p.regCount, s.schedulecount
			    FROM pt p LEFT OUTER JOIN
			            (SELECT ptNo, COUNT(scheduleNo) scheduleCount
			            FROM schedule
			            group by ptNo) s
			    ON p.ptno = s.ptno
			    AND p.trainerno = #{trainerNo}) pt
			WHERE u.userNo = pt.userno

		 ]]>
	</select>
	
		<select id="selectPtInfo" parameterType="map" resultType="com.javaex.vo.PtVo">
		<![CDATA[
		
			SELECT
			    pt.ptNo, u.userNo, u.userId, u.name, u.gender, u.phone,
			    to_char(pt.endDate, 'yyyymmdd') intEndDate,
			    to_char(pt.startdate, 'yyyy-mm-dd') startDate,
			    to_char(pt.endDate, 'yyyy-mm-dd') endDate,
			    pt.regcount, NVL(pt.schedulecount, 0) schdulecount, NVL(pt.memo, ' ') memo
			FROM
			    users u,
			    (SELECT
			        p.ptNo, p.userNo, p.startdate,
			        p.endDate, p.regCount, s.schedulecount, p.memo
			    FROM pt p LEFT OUTER JOIN
			            (SELECT ptNo, COUNT(scheduleNo) scheduleCount
			            FROM schedule
			            group by ptNo) s
			    ON p.ptno = s.ptno
			    AND p.trainerno = #{trainerNo}) pt
			WHERE u.userNo = pt.userno
			and pt.ptno = #{ptNo}

		 ]]>
	</select>
	
	<!-- 회원검색 -->
	<select id="selectUserInfo" parameterType="String" resultType="com.javaex.vo.UserVo">
		<![CDATA[
		
			SELECT userNo, userId, name
			FROM users
			WHERE usertype = 'normal'
			AND userId = #{userId}
			
		]]>
	</select>
	
	<!-- pt등록 -->
	<insert id="insertPt" parameterType="map">
		<![CDATA[
		
			INSERT INTO pt
			VALUES(SEQ_PTNO.nextval, #{userNo}, #{trainerNo}, SYSDATE, ADD_MONTHS(SYSDATE, #{period}), #{regCount}, '')
	
		]]>
	</insert>
	
	<!-- 메모수정 -->
	<update id="updateMemo" parameterType="map">
		<![CDATA[
		
			UPDATE pt
			SET memo = #{memo}
			WHERE ptNo = #{ptNo}
		
		]]>
	</update>
	
	
</mapper>
