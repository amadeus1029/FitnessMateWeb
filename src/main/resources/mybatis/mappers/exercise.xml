<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="exercise">
    <select id="showList" resultType="ExVo">
        <![CDATA[
            select  partNo as exPartNo,
                    partName as exPartName
            from    ex_part
            order by partNo asc
        ]]>
    </select>
    <select id="getList" parameterType="int" resultType="ExVo">
        <![CDATA[
            select  ex.exerciseNo as exNo,
                    ex.exerciseName as exName,
                    p.partName as exPartName,
                    ex.unit as unit
            from    exercise ex, ex_part p
            where   ex.trainerNo = #{trainerNo}
            and     ex.exercisepart = p.partNo
            order by ex.exerciseNo asc
        ]]>
    </select>
    <select id="partList" parameterType="int" resultType="ExVo">
        <![CDATA[
            select  exp.exPartNo as exPartNo,
                    p.partName as exPartName
            from    ex_part p, (select  exPartNo,
                                        count(*)
                                from    (select e.exercisepart as exPartNo
                                        from    exercise e, ex_part p
                                        where   e.exercisepart = p.partno and e.trainerno = #{trainerNo})
                                group by exPartNo
                                order by exPartNo) exp
            where   p.partNo = exp.expartno
        ]]>
    </select>
    <select id="selectByPart" parameterType="ExVo" resultType="ExVo">
        <![CDATA[
            select  e.exerciseno as exNo,
                    e.exercisename as exName,
                    e.unit as unit
            from    exercise e, ex_part p
            where   e.exercisepart = p.partNo and e.trainerNo = #{trainerNo} and e.exercisepart = #{exPartNo}
            order by e.exerciseno asc
        ]]>
    </select>
    <select id="selectByNo" parameterType="int" resultType="ExVo">
        <![CDATA[
            select  ex.exerciseNo as exNo,
                    ex.exerciseName as exName,
                    p.partName as exPartName,
                    ex.unit as unit
            from    exercise ex, ex_part p
            where   ex.exerciseNo = #{exNo}
            and     ex.exercisepart = p.partNo
        ]]>
    </select>
    <insert id="insertSelectKey" parameterType="ExVo">
        <selectKey keyProperty="exNo" resultType="int" order="BEFORE">
            <![CDATA[
                select seq_exerciseno.nextVal from dual
            ]]>
        </selectKey>
        <![CDATA[
            insert into exercise
            values(#{exNo}, #{trainerNo}, #{exName}, #{exPartNo}, #{unit})
        ]]>
    </insert>
    <delete id="delete" parameterType="ExVo">
        <![CDATA[
            delete exercise
            where exerciseNo = #{exNo} and trainerNo = #{trainerNo}
        ]]>
    </delete>
    
    <select id="selectExDate" parameterType="int" resultType="String">
        <![CDATA[
        
			SELECT TO_CHAR(s.startTime, 'yyyy-mm-dd') startTime
			FROM schedule s left outer join pt p
			ON s.ptNo = p.ptNo
			WHERE p.ptNo = (SELECT MAX(ptNo)
				            FROM pt
				            WHERE userNo = #{userNo})
			ORDER by s.startTime desc

        ]]>
    </select>
    
    <select id="selectExList" parameterType="int" resultType="com.javaex.vo.RecordVo">
        <![CDATA[
        
			SELECT exe.exercisename exName, exe.partName exPart, exe.unit, count.setCount
			FROM (SELECT distinct ex.exercisename, p.partName, ex.unit, ex.exerciseno
					FROM ex_part p
					RIGHT OUTER JOIN (SELECT e.exerciseno, e.exercisepart, e.exercisename, e.unit
                                        FROM records r LEFT OUTER JOIN exercise e
                                        ON r.exerciseno = e.exerciseno
                                        WHERE r.scheduleNo = (SELECT Max(s.scheduleNo)
                                                            FROM schedule s left outer join pt p
                                                            ON s.ptNo = p.ptNo
                                                            WHERE p.ptNo = (SELECT max(ptNo)
                                                                        FROM pt
                                                                        WHERE userNo = #{userNo})
                                                            AND TO_CHAR(s.startTime, 'yyyymmdd') < TO_CHAR(sysdate, 'yyyymmdd'))) ex
			        on p.partNo = ex.exercisepart) exe, (SELECT count(exerciseNo) setCount, exerciseNo FROM records GROUP BY exerciseNo) count
			WHERE exe.exerciseno = count.exerciseNo

        ]]>
    </select>
    
	<select id="selectSetList" parameterType="int" resultType="com.javaex.vo.RecordVo">
        <![CDATA[
        
			SELECT ex.exercisename exName, ex.count, ex.amount
			FROM ex_part p
			RIGHT OUTER JOIN (SELECT e.exercisepart, e.exercisename, r.count, r.amount
                              FROM records r LEFT OUTER JOIN exercise e
                              ON r.exerciseno = e.exerciseno
                              WHERE r.scheduleNo = (SELECT Max(s.scheduleNo)
                                                  FROM schedule s LEFT OUTER JOIN pt p
                                                  ON s.ptNo = p.ptNo
                                                  WHERE p.ptNo = (SELECT max(ptNo)
	                                                              FROM pt
	                                                              WHERE userNo = #{userNo})
                                                  AND TO_CHAR(s.startTime, 'yyyymmdd') < TO_CHAR(sysdate, 'yyyymmdd'))) ex
			ON p.partNo = ex.exercisepart

        ]]>
    </select>
    
</mapper>

        <!--
        <![CDATA[
        ]]>
        -->